{% extends "base.html" %}

{% block title %}{{ 'Modifier' if facture else 'Ajouter' }} une facture{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ 'Modifier' if facture else 'Ajouter' }} une facture</h1>
        <a href="{{ url_for('factures_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="POST" id="factureForm">
                {{ form.hidden_tag() }}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            {{ form.client_id.label(class="form-label") }}
                            {{ form.client_id(class="form-select", id="client_select") }}
                            {% if form.client_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.client_id.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.prestation_id.label(class="form-label") }}
                            {{ form.prestation_id(class="form-select", id="prestation_select") }}
                            {% if form.prestation_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.prestation_id.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.numero.label(class="form-label") }}
                            {{ form.numero(class="form-control") }}
                            {% if form.numero.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.numero.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.date_emission.label(class="form-label") }}
                            {{ form.date_emission(class="form-control", type="date") }}
                            {% if form.date_emission.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.date_emission.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.date_echeance.label(class="form-label") }}
                            {{ form.date_echeance(class="form-control", type="date") }}
                            {% if form.date_echeance.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.date_echeance.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            {{ form.statut.label(class="form-label") }}
                            {{ form.statut(class="form-select") }}
                            {% if form.statut.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.statut.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.mode_paiement.label(class="form-label") }}
                            {{ form.mode_paiement(class="form-select") }}
                            {% if form.mode_paiement.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.mode_paiement.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3" id="date_paiement_group">
                            {{ form.date_paiement.label(class="form-label") }}
                            {{ form.date_paiement(class="form-control", type="date") }}
                            {% if form.date_paiement.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.date_paiement.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.taux_tva.label(class="form-label") }}
                            {{ form.taux_tva(class="form-control") }}
                            {% if form.taux_tva.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.taux_tva.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows="4") }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.notes.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <h3 class="mb-3">Lignes de facturation</h3>
                
                <div id="lignes-container">
                    <!-- Template pour ligne de facturation -->
                    <div class="ligne-item card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-5">
                                    <label class="form-label">Description</label>
                                    <input type="text" name="lignes-description[]" class="form-control description-input">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantité</label>
                                    <input type="number" name="lignes-quantite[]" class="form-control quantite-input" value="1" step="0.01">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Prix unitaire</label>
                                    <input type="number" name="lignes-prix_unitaire[]" class="form-control prix-unitaire-input" value="0" step="0.01">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Montant</label>
                                    <input type="number" class="form-control montant-input" readonly>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger delete-ligne-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button type="button" id="add-ligne-btn" class="btn btn-secondary">
                        <i class="fas fa-plus me-1"></i>Ajouter une ligne
                    </button>
                </div>
                
                <div class="row justify-content-end mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Total HT:</span>
                                    <span id="total-ht">0.00 €</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>TVA ({{ form.taux_tva.data or 20 }}%):</span>
                                    <span id="total-tva">0.00 €</span>
                                </div>
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Total TTC:</span>
                                    <span id="total-ttc">0.00 €</span>
                                </div>
                                {{ form.montant_ht(type="hidden", id="montant_ht") }}
                                {{ form.montant_ttc(type="hidden", id="montant_ttc") }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('factures_list') }}" class="btn btn-secondary">Annuler</a>
                    <button type="submit" class="btn btn-primary">
                        {{ 'Enregistrer les modifications' if facture else 'Créer la facture' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function() {
        // Gestion de l'affichage du champ date de paiement en fonction du statut
        function toggleDatePaiement() {
            if ($('#statut').val() === 'payee') {
                $('#date_paiement_group').show();
            } else {
                $('#date_paiement_group').hide();
            }
        }
        
        // Initialisation
        toggleDatePaiement();
        
        // Événement de changement de statut
        $('#statut').change(function() {
            toggleDatePaiement();
        });
        
        // Filtrer les prestations en fonction du client sélectionné
        $('#client_select').change(function() {
            const clientId = $(this).val();
            if (clientId) {
                $.ajax({
                    url: "{{ url_for('get_prestations_by_client') }}",
                    data: { client_id: clientId },
                    type: 'GET',
                    success: function(response) {
                        $('#prestation_select').empty();
                        $('#prestation_select').append('<option value="">Sélectionnez une prestation</option>');
                        $.each(response.prestations, function(i, prestation) {
                            $('#prestation_select').append($('<option>', {
                                value: prestation.id,
                                text: prestation.adresse_depart + ' → ' + prestation.adresse_arrivee
                            }));
                        });
                    }
                });
            } else {
                $('#prestation_select').empty();
                $('#prestation_select').append('<option value="">Sélectionnez d\'abord un client</option>');
            }
        });
        
        // Générer un numéro de facture automatiquement
        if (!$('#numero').val()) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            $('#numero').val(`FAC-${year}${month}${day}-${random}`);
        }
        
        // Mettre à jour les montants lorsque les quantités ou prix changent
        $(document).on('input', '.quantite-input, .prix-unitaire-input', function() {
            updateLigneMontant($(this).closest('.ligne-item'));
            updateTotals();
        });
        
        // Mettre à jour le montant d'une ligne
        function updateLigneMontant(ligneItem) {
            const quantite = parseFloat(ligneItem.find('.quantite-input').val()) || 0;
            const prix = parseFloat(ligneItem.find('.prix-unitaire-input').val()) || 0;
            const montant = quantite * prix;
            ligneItem.find('.montant-input').val(montant.toFixed(2));
        }
        
        // Mettre à jour les totaux
        function updateTotals() {
            let totalHT = 0;
            
            $('.ligne-item').each(function() {
                const montant = parseFloat($(this).find('.montant-input').val()) || 0;
                totalHT += montant;
            });
            
            const tauxTVA = parseFloat($('#taux_tva').val()) || 20;
            const montantTVA = totalHT * (tauxTVA / 100);
            const totalTTC = totalHT + montantTVA;
            
            $('#total-ht').text(totalHT.toFixed(2) + ' €');
            $('#total-tva').text(montantTVA.toFixed(2) + ' €');
            $('#total-ttc').text(totalTTC.toFixed(2) + ' €');
            
            // Mettre à jour les champs cachés
            $('#montant_ht').val(totalHT.toFixed(2));
            $('#montant_ttc').val(totalTTC.toFixed(2));
        }
        
        // Ajouter une nouvelle ligne de facturation
        $('#add-ligne-btn').click(function() {
            const newLigne = $('.ligne-item:first').clone();
            newLigne.find('input[type="text"], input[type="number"]').val('');
            newLigne.find('.quantite-input').val('1');
            newLigne.find('.prix-unitaire-input').val('0');
            newLigne.find('.montant-input').val('0');
            $('#lignes-container').append(newLigne);
            updateTotals();
        });
        
        // Supprimer une ligne de facturation
        $(document).on('click', '.delete-ligne-btn', function() {
            const lignesCount = $('.ligne-item').length;
            if (lignesCount > 1) {
                $(this).closest('.ligne-item').remove();
                updateTotals();
            } else {
                alert('Vous devez avoir au moins une ligne de facturation.');
            }
        });
        
        // Initialiser les montants des lignes existantes
        $('.ligne-item').each(function() {
            updateLigneMontant($(this));
        });
        
        // Calculer les totaux au chargement
        updateTotals();
        
        // Mettre à jour les totaux lorsque le taux de TVA change
        $('#taux_tva').on('input', function() {
            updateTotals();
        });
        
        // Validation du formulaire
        $('#factureForm').submit(function(e) {
            if ($('.ligne-item').length === 0) {
                e.preventDefault();
                alert('Veuillez ajouter au moins une ligne à la facture.');
                return false;
            }
            
            if (!$('#client_select').val()) {
                e.preventDefault();
                alert('Veuillez sélectionner un client.');
                return false;
            }
            
            if (!$('#prestation_select').val() || $('#prestation_select').val() === '0') {
                e.preventDefault();
                alert('Veuillez sélectionner une prestation valide.');
                return false;
            }
            
            return true;
        });
    });
</script>
{% endblock %}
