{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Modifier l'événement</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('calendrier.traiter_modification_evenement', evenement_id=evenement.id) }}">
                        <div class="mb-3">
                            <label class="form-label">Titre</label>
                            <input type="text" class="form-control" name="titre" value="{{ evenement.titre }}" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Date de début</label>
                                    <input type="datetime-local" class="form-control" name="date_debut" value="{{ evenement.date_debut.isoformat(timespec='minutes') }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Date de fin</label>
                                    <input type="datetime-local" class="form-control" name="date_fin" value="{{ evenement.date_fin.isoformat(timespec='minutes') if evenement.date_fin else '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type d'événement</label>
                            <select class="form-select" name="type_evenement" required>
                                <option value="">Sélectionnez un type...</option>
                                <option value="prestation" {% if evenement.type_evenement == 'prestation' %}selected{% endif %}>Prestation</option>
                                <option value="stockage" {% if evenement.type_evenement == 'stockage' %}selected{% endif %}>Stockage</option>
                                <option value="autre" {% if evenement.type_evenement == 'autre' %}selected{% endif %}>Autre</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observations</label>
                            <textarea class="form-control" name="observations" rows="4">{{ evenement.observations }}</textarea>
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('calendrier.voir_agenda', agenda_id=agenda.id) }}" class="btn btn-secondary">Annuler</a>
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Informations</h5>
                </div>
                <div class="card-body">
                    <p><strong>Version actuelle:</strong> {{ evenement.version or 1 }}</p>
                    <p><strong>Créé le:</strong> {{ evenement.date_creation.strftime('%d/%m/%Y à %H:%M') if evenement.date_creation else 'Non spécifié' }}</p>
                    <p><strong>Dernière modification:</strong> {{ evenement.date_modification.strftime('%d/%m/%Y à %H:%M') if evenement.date_modification else 'Jamais' }}</p>
                    <p><strong>Agenda:</strong> <a href="{{ url_for('calendrier.voir_agenda', agenda_id=agenda.id) }}">{{ agenda.nom }}</a></p>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title">Historique des versions</h5>
                </div>
                <div class="card-body">
                    {% if versions %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Version</th>
                                        <th>Date de modification</th>
                                        <th>Titre</th>
                                        <th>Type</th>
                                        <th>Observations</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for version in versions %}
                                    <tr>
                                        <td>v{{ version.version }}</td>
                                        <td>{{ version.date_modification.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>{{ version.titre }}</td>
                                        <td>{{ version.type_evenement }}</td>
                                        <td>{{ version.observations|truncate(50) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">L'historique des versions sera disponible après la première modification.</p>
                    {% endif %}
                    <p>Version actuelle: v{{ evenement.version or 1 }}</p>
                </div>
            </div>
            
            <!-- Section Documents -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Documents</h5>
                </div>
                <div class="card-body">
                    <!-- Liste des documents existants -->
                    <div class="mb-4">
                        <h6>Documents associés</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Date d'ajout</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="documents-list">
                                    {% if evenement.documents %}
                                        {% for document in evenement.documents %}
                                        <tr>
                                            <td>{{ document.nom }}</td>
                                            <td>{{ document.date_upload.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td>
                                                <a href="{{ url_for('calendrier.telecharger_document_evenement', document_id=document.id) }}" class="btn btn-sm btn-info">
                                                    <i class="fas fa-download"></i> Télécharger
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="3" class="text-center">Aucun document associé</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Formulaire d'ajout de document -->
                    <h6>Ajouter un document</h6>
                    <form action="{{ url_for('calendrier.ajouter_document_evenement', evenement_id=evenement.id) }}" method="POST" enctype="multipart/form-data" id="upload-form">
                        <div class="mb-3">
                            <label for="document" class="form-label">Sélectionner un fichier</label>
                            <input type="file" class="form-control" id="document" name="document" required>
                            <div class="form-text">Formats acceptés: PDF, PNG, JPG, JPEG, DOC, DOCX, XLS, XLSX, TXT</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Ajouter le document
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
